CREATE DATABASE CardMarket;

GO

USE CardMarket;

GO

CREATE TABLE Conti (
     IDConto INT IDENTITY(1,1) PRIMARY KEY NOT NULL,
     IBAN CHAR(27) NOT NULL,
     NomeDellaBanca VARCHAR(40) NOT NULL,
     BIC_SWIFT VARCHAR(11) NOT NULL);

CREATE TABLE Utenti (
     Username VARCHAR(15) PRIMARY KEY NOT NULL,
     Email VARCHAR(30) NOT NULL,
     Password VARCHAR(100) NOT NULL,
     Via VARCHAR(20),
	 NCivico INT,
	 CAP INT,
	 Citta VARCHAR(30),
	 Paese VARCHAR(30),
     NumeroDiTelefono VARCHAR(15),
     Credito INT NOT NULL,
	 IDConto INT,
	 FOREIGN KEY (IDConto) REFERENCES Conti(IDConto),
	 UNIQUE(Email),
	 UNIQUE(NumeroDiTelefono),
	 CHECK (Credito > 0));

CREATE TABLE Venditori (
     Username VARCHAR(15) PRIMARY KEY NOT NULL,
     Email VARCHAR(30) NOT NULL,
     Password VARCHAR(100) NOT NULL,
     Paese VARCHAR(25) NOT NULL,
     DataDiRegistrazione DATE NOT NULL,
	 IDConto INT NOT NULL,
	 FOREIGN KEY (IDConto) REFERENCES Conti(IDConto),
	 UNIQUE(Email));

CREATE TABLE Admin (
     Username VARCHAR(15) PRIMARY KEY NOT NULL,
     Email VARCHAR(30) NOT NULL,
     Password VARCHAR(100) NOT NULL,
     DataDiScadenza DATE DEFAULT GETDATE(),
	 UNIQUE(Email));

CREATE TABLE Coupon (
     CodiceCoupon VARCHAR(10) PRIMARY KEY,
     DataDiScadenza DATE NOT NULL,
     Valore INT NOT NULL,
	 UsernameGeneratore VARCHAR(15),
	 UsernameUtilizzatore VARCHAR(15),
	 FOREIGN KEY (UsernameGeneratore) REFERENCES Utenti(Username),
	 FOREIGN KEY (UsernameUtilizzatore) REFERENCES Utenti(Username));

CREATE TABLE Rarita (
     Nome VARCHAR(15) PRIMARY KEY NOT NULL);

CREATE TABLE Giochi (
     Nome VARCHAR(20) PRIMARY KEY NOT NULL);
	 
CREATE TABLE Espansioni (
     Nome VARCHAR(40) PRIMARY KEY NOT NULL,
     DataDiRilascio DATE DEFAULT GETDATE() NOT NULL);

CREATE TABLE Prodotti (
     IDProdotto INT IDENTITY(1,1) PRIMARY KEY NOT NULL,
     Nome VARCHAR(30) NOT NULL,
     DataDiRilascio DATE DEFAULT GETDATE() NOT NULL,
     Descrizione VARCHAR(100) NOT NULL,
	 Rarita VARCHAR(15) NOT NULL,
	 Gioco VARCHAR(20) NOT NULL,
	 Espansione VARCHAR(40),
	 FOREIGN KEY (Rarita) REFERENCES Rarita(Nome),
	 FOREIGN KEY (Gioco) REFERENCES Giochi(Nome),
	 FOREIGN KEY (Espansione) REFERENCES Espansioni(Nome));

CREATE TABLE ListeDesideri (
	Username VARCHAR(15),
	IDProdotto INT,
	Quantita INT,
	FOREIGN KEY (Username) REFERENCES Utenti(Username),
	FOREIGN KEY (IDProdotto) REFERENCES Prodotti(IDProdotto),
	PRIMARY KEY (Username, IDProdotto),
	CHECK (Quantita > 0));

CREATE TABLE Condizioni(
	Nome VARCHAR(15) PRIMARY KEY NOT NULL);

CREATE TABLE Offerte (
     IDOfferta INT IDENTITY(1,1) PRIMARY KEY NOT NULL,
     Prezzo MONEY NOT NULL,
     Quantita INT NOT NULL,
     Condizione VARCHAR(15),
     Lingua VARCHAR(3) NOT NULL,
     Locazione VARCHAR(20) NOT NULL,
	 UsernameVenditore VARCHAR(15) NOT NULL,
	 FOREIGN KEY (UsernameVenditore) REFERENCES Venditori(Username),
	 FOREIGN KEY (Condizione) REFERENCES Condizioni(Nome),
	 CHECK(Quantita > 0),
	 CHECK(Prezzo >= 0));

CREATE TABLE Feedback (
     IDFeedback INT IDENTITY(1,1) PRIMARY KEY NOT NULL,
     Testo VARCHAR(100) NOT NULL,
     Voto INT NOT NULL,
	 Utente VARCHAR(15),
	 FOREIGN KEY (Utente) REFERENCES Utenti(Username),
	 CHECK(Voto >= 0 AND Voto <= 10));

CREATE TABLE Vendite (
     IDVendita INT IDENTITY(1,1) PRIMARY KEY NOT NULL,
     Data DATETIME DEFAULT GETDATE() NOT NULL,
	 Aquirente VARCHAR(15) NOT NULL,
	 Venditore VARCHAR(15) NOT NULL,
	 Feedback INT NOT NULL,
	 FOREIGN KEY (Venditore) REFERENCES Venditori(Username),
	 FOREIGN KEY (Aquirente) REFERENCES Utenti(Username),
	 FOREIGN KEY (Feedback) REFERENCES Feedback(IDFeedback));

CREATE TABLE Dettagli (
     IDDettaglio INT IDENTITY(1,1) PRIMARY KEY NOT NULL,
     Prezzo MONEY NOT NULL,
     Quantita INT NOT NULL,
	 IDOfferta INT NOT NULL,
	 IDVendita INT NOT NULL,
	 FOREIGN KEY (IDOfferta) REFERENCES Offerte(IDOfferta),
	 FOREIGN KEY (IDVendita) REFERENCES Vendite(IDVendita),
	 CHECK(Quantita > 0),
	 CHECK(Prezzo >= 0));


INSERT INTO Condizioni VALUES ('Perfetto'), ('Molto buono'), ('Buono'), ('Rovinato'), ('Molto rovinato');

INSERT INTO Rarita VALUES ('Comune'), ('Rara'), ('Super Rara'), ('Ultra Rara'), ('Rara Ultimate'), ('Rara Ghost');

INSERT INTO Giochi VALUES ('Yu-Gi-Oh!'), ('Pokemon'), ('Magic: The Gathering');

INSERT INTO Prodotti(Nome, Descrizione, Rarita, Gioco) VALUES('Jinzo', 'Mucho fuerte', 'Comune', 'Yu-Gi-Oh!')